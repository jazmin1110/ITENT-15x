<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Worker Profile</title>

  <!-- Bootstrap CDN (optional but recommended) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-3">
  <div class="container" style="max-width: 520px;">
    <h3 class="mb-3">Worker Profile</h3>
    <p class="text-muted mb-4">Ilagay ang basic info para mas mabilis kang ma-match sa trabaho.</p>

    <div class="mb-3">
      <label class="form-label">Buong Pangalan</label>
      <input id="full_name" class="form-control" placeholder="Juan Dela Cruz" />
    </div>

    <div class="mb-3">
      <label class="form-label">Lungsod</label>
      <input id="city" class="form-control" placeholder="Quezon City" />
    </div>

    <div class="mb-3">
      <label class="form-label">Contact Number</label>
      <input id="contact_number" class="form-control" placeholder="09XXXXXXXXX" />
    </div>

    <div class="mb-3">
      <label class="form-label">Years of Experience</label>
      <input id="years_experience" type="number" class="form-control" min="0" placeholder="e.g., 3" />
    </div>

    <div class="mb-3">
      <label class="form-label">Kailan ka pwedeng magsimula?</label>
      <input id="availability_date" type="date" class="form-control" />
    </div>

    <div class="mb-3">
      <label class="form-label">Skills (pwede marami)</label>
      <div class="form-check">
        <input class="form-check-input skill" type="checkbox" value="Masonry" id="skill1">
        <label class="form-check-label" for="skill1">Masonry</label>
      </div>
      <div class="form-check">
        <input class="form-check-input skill" type="checkbox" value="Carpentry" id="skill2">
        <label class="form-check-label" for="skill2">Carpentry</label>
      </div>
      <div class="form-check">
        <input class="form-check-input skill" type="checkbox" value="Helper" id="skill3">
        <label class="form-check-label" for="skill3">Helper</label>
      </div>
      <div class="form-check">
        <input class="form-check-input skill" type="checkbox" value="Painting" id="skill4">
        <label class="form-check-label" for="skill4">Painting</label>
      </div>
      <div class="form-check">
        <input class="form-check-input skill" type="checkbox" value="Driver" id="skill5">
        <label class="form-check-label" for="skill5">Driver</label>
      </div>
    </div>

    <div class="d-grid gap-2">
      <button id="saveBtn" type="button" class="btn btn-primary">Save Profile</button>
      <a href="jobs.html" class="btn btn-success mt-2">Browse Available Jobs</a>      
      <button id="logoutBtn" type="button" class="btn btn-outline-secondary">Logout</button>
    </div>

    <p id="msg" class="mt-3"></p>
  </div>

  <script type="module">
    import { supabase } from "./js/supabaseClient.js";

    const msg = document.getElementById("msg");

    async function requireAuth() {
      const { data } = await supabase.auth.getUser();
      if (!data?.user) window.location.href = "auth.html";
      return data.user;
    }

    function getSelectedSkills() {
      return [...document.querySelectorAll(".skill:checked")].map(cb => cb.value);
    }

    function setSelectedSkills(skills) {
      document.querySelectorAll(".skill").forEach(cb => {
        cb.checked = skills?.includes(cb.value) ?? false;
      });
    }

    async function loadProfile(user) {
      const { data, error } = await supabase
        .from("worker_profiles")
        .select("*")
        .eq("user_id", user.id)
        .maybeSingle();

      if (error) {
        msg.textContent = "Error loading profile: " + error.message;
        return;
      }

      if (!data) return; // first time user, no row yet

      full_name.value = data.full_name ?? "";
      city.value = data.city ?? "";
      contact_number.value = data.contact_number ?? "";
      years_experience.value = data.years_experience ?? "";
      availability_date.value = data.availability_date ?? "";
      setSelectedSkills(data.skills ?? []);
    }

    async function saveProfile(user) {
      msg.textContent = "Saving...";
      const payload = {
        user_id: user.id,
        full_name: full_name.value.trim(),
        city: city.value.trim(),
        contact_number: contact_number.value.trim(),
        years_experience: years_experience.value ? Number(years_experience.value) : null,
        availability_date: availability_date.value || null,
        skills: getSelectedSkills()
      };

      // basic validation
      if (!payload.full_name || !payload.city) {
        msg.textContent = "Paki-lagay ang pangalan at lungsod.";
        return;
      }

      const { error } = await supabase
        .from("worker_profiles")
        .upsert(payload);

      msg.textContent = error ? ("Save failed: " + error.message) : "Profile saved âœ…";
    }

    // main
    const user = await requireAuth();
    await loadProfile(user);

    document.getElementById("saveBtn").addEventListener("click", async () => {
      await saveProfile(user);
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "auth.html";
    });
  </script>
</body>
</html>
